name: Strapi Warmup

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  warmup:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Warmup Strapi
        shell: bash
        run: |
          set -euo pipefail

          STRAPI_URL="${{ vars.STRAPI_WARMUP_URL }}"

          if [ -z "${STRAPI_URL:-}" ]; then
            echo "âŒ STRAPI_WARMUP_URL repository variable is not set"
            exit 1
          fi

          # (ì„ íƒ) URL ëì— /ê°€ ë¶™ì–´ìˆìœ¼ë©´ ì œê±°
          STRAPI_URL="${STRAPI_URL%/}"

          echo "ğŸ”¥ Warming up: ${STRAPI_URL}/_health"

          # Strapi health check: 204 No Content (ì •ìƒ) :contentReference[oaicite:1]{index=1}
          HTTP_CODE=$(curl -sS -o /dev/null \
            --max-time 25 --connect-timeout 10 \
            -H "User-Agent: GitHub-Actions-Strapi-Warmup/1.0" \
            -w "%{http_code}" \
            "${STRAPI_URL}/_health" || true)

          echo "HTTP Status: ${HTTP_CODE}"

          if [ "${HTTP_CODE}" = "204" ] || [ "${HTTP_CODE}" = "200" ]; then
            echo "âœ… Warmup successful"
            exit 0
          fi

          echo "âš ï¸ Warmup got HTTP ${HTTP_CODE}"
          # cold start ì¤‘ì—” 502/503/504 ê°™ì€ ê²Œ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ. ë‹¤ìŒ í˜¸ì¶œ ë•Œ ê¹¨ì–´ìˆì„ ê°€ëŠ¥ì„± ë†’ìŒ
          exit 0
